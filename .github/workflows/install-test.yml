name: Install Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  install-uninstall:
    name: Test install and uninstall
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Check if Claude auth is available
        id: auth
        run: |
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "Claude auth available — running full install test"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "No ANTHROPIC_API_KEY secret — running structure-only tests"
          fi

      - name: Test per-session load (--plugin-dir)
        if: steps.auth.outputs.available == 'true'
        run: |
          OUTPUT=$(CLAUDECODE= claude --plugin-dir . -p "list all slash commands" --output-format json 2>&1 || true)
          if echo "$OUTPUT" | grep -q "production-master"; then
            echo "OK: --plugin-dir loads plugin correctly"
          else
            echo "FAIL: --plugin-dir did not load production-master commands"
            echo "$OUTPUT" | head -20
            exit 1
          fi

      - name: Install plugin
        if: steps.auth.outputs.available == 'true'
        run: |
          CLAUDECODE= claude plugin marketplace add . 2>&1
          echo "OK: marketplace added"

          INSTALL_OUTPUT=$(CLAUDECODE= claude plugin install production-master --scope user 2>&1)
          echo "$INSTALL_OUTPUT"
          if echo "$INSTALL_OUTPUT" | grep -q "Successfully installed"; then
            echo "OK: plugin installed"
          else
            echo "FAIL: plugin install failed"
            exit 1
          fi

      - name: Verify plugin status
        if: steps.auth.outputs.available == 'true'
        run: |
          STATUS=$(CLAUDECODE= claude plugin list 2>&1)
          echo "$STATUS"
          if echo "$STATUS" | grep -q "Status: ✔ enabled"; then
            echo "OK: plugin is enabled"
          else
            echo "FAIL: plugin is not enabled"
            exit 1
          fi

      - name: Verify no recursive nesting in cache
        if: steps.auth.outputs.available == 'true'
        run: |
          CACHE_DIR="$HOME/.claude/plugins/cache/production-master"
          NEST_COUNT=$(find "$CACHE_DIR" -maxdepth 8 -name "production-master" -type d 2>/dev/null | wc -l | tr -d ' ')
          echo "production-master directories found: $NEST_COUNT"
          if [ "$NEST_COUNT" -gt 3 ]; then
            echo "FAIL: recursive nesting detected ($NEST_COUNT directories)"
            find "$CACHE_DIR" -maxdepth 8 -name "production-master" -type d
            exit 1
          fi
          echo "OK: no recursive nesting"

      - name: Verify installed content
        if: steps.auth.outputs.available == 'true'
        run: |
          CACHE_DIR=$(find "$HOME/.claude/plugins/cache/production-master" -maxdepth 2 -name "1.0.0*" -type d | head -1)
          echo "Cache dir: $CACHE_DIR"
          ERRORS=0

          for cmd in production-master.md git-update-agents.md update-context.md fire-console.md grafana-query.md production-changes.md resolve-artifact.md slack-search.md; do
            if [ ! -f "$CACHE_DIR/commands/$cmd" ]; then
              echo "FAIL: commands/$cmd missing"
              ERRORS=$((ERRORS + 1))
            fi
          done

          for agent in artifact-resolver.md bug-context.md codebase-semantics.md documenter.md fix-list.md grafana-analyzer.md hypotheses.md production-analyzer.md publisher.md skeptic.md slack-analyzer.md verifier.md; do
            if [ ! -f "$CACHE_DIR/agents/$agent" ]; then
              echo "FAIL: agents/$agent missing"
              ERRORS=$((ERRORS + 1))
            fi
          done

          for skill in context7 fire-console ft-release github grafana-datasource grafana-mcp jira octocode slack; do
            if [ ! -f "$CACHE_DIR/skills/$skill/SKILL.md" ]; then
              echo "FAIL: skills/$skill/SKILL.md missing"
              ERRORS=$((ERRORS + 1))
            fi
          done

          [ "$ERRORS" -eq 0 ] || exit 1
          echo "OK: all 8 commands, 12 agents, 9 skills present"

      - name: Uninstall and cleanup
        if: steps.auth.outputs.available == 'true'
        run: |
          CLAUDECODE= claude plugin uninstall production-master --scope user 2>&1
          echo "OK: plugin uninstalled"

          STATUS=$(CLAUDECODE= claude plugin list 2>&1)
          if echo "$STATUS" | grep -q "production-master"; then
            echo "FAIL: plugin still listed after uninstall"
            exit 1
          fi
          echo "OK: plugin fully removed"

          CLAUDECODE= claude plugin marketplace remove production-master 2>&1
          echo "OK: marketplace removed"

      # ── Structure-only tests (no auth required) ──────────────────────

      - name: Validate install.sh is runnable
        run: |
          bash -n scripts/install.sh
          echo "OK: install.sh has valid syntax"

      - name: Simulate install structure
        run: |
          # Simulate what the plugin cache should look like
          CACHE="/tmp/plugin-test"
          mkdir -p "$CACHE"
          cp -r commands agents skills hooks mcp-servers.json "$CACHE/"

          ERRORS=0
          for cmd in production-master.md git-update-agents.md update-context.md fire-console.md grafana-query.md production-changes.md resolve-artifact.md slack-search.md; do
            [ -f "$CACHE/commands/$cmd" ] || { echo "FAIL: commands/$cmd"; ERRORS=$((ERRORS + 1)); }
          done

          for agent in artifact-resolver.md bug-context.md codebase-semantics.md documenter.md fix-list.md grafana-analyzer.md hypotheses.md production-analyzer.md publisher.md skeptic.md slack-analyzer.md verifier.md; do
            [ -f "$CACHE/agents/$agent" ] || { echo "FAIL: agents/$agent"; ERRORS=$((ERRORS + 1)); }
          done

          for skill in context7 fire-console ft-release github grafana-datasource grafana-mcp jira octocode slack; do
            [ -f "$CACHE/skills/$skill/SKILL.md" ] || { echo "FAIL: skills/$skill/SKILL.md"; ERRORS=$((ERRORS + 1)); }
          done

          [ "$ERRORS" -eq 0 ] || exit 1
          echo "OK: all plugin content would be installed correctly"
          rm -rf "$CACHE"
